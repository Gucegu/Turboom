<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes do Ticket</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      background-color: #f7f8fc;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      width: 900px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      padding: 30px;
      display: flex;
      flex-direction: column;
      min-height: 80vh;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }

    .ticket-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .ticket-info h2 {
      font-size: 24px;
      color: #000;
    }

    .tag {
      background-color: #4f46e5;
      color: #fff;
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .actions button {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: 0.2s;
    }

    .btn-encaminhar {
      background-color: #f3f4f6;
      color: #4f46e5;
      border: 1px solid #d1d5db;
    }

    .btn-encaminhar:hover {
      background-color: #e5e7eb;
    }

    .btn-encerrar {
      background-color: #dc2626;
      color: #fff;
    }

    .btn-encerrar:hover {
      background-color: #b91c1c;
    }

    .btn-voltar {
      background-color: #6b7280;
      color: #fff;
    }

    .btn-voltar:hover {
      background-color: #4b5563;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-info h3 {
      font-size: 18px;
      font-weight: 600;
    }

    .user-info p {
      font-size: 14px;
      color: #666;
    }

    .ticket-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
      margin-bottom: 25px;
      padding: 0 15px;
    }

    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 400px;
    }

    /* MINHA MENSAGEM (direita - branca) - igual para ambos */
    .minha-mensagem {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 10px 10px 0 10px;
      padding: 15px;
      max-width: 80%;
      align-self: flex-end;
      margin-left: 20%;
    }

    /* MENSAGEM DO OUTRO (esquerda - roxa) - igual para ambos */
    .mensagem-outro {
      background-color: #b398d1;
      color: white;
      border-radius: 10px 10px 10px 0;
      padding: 15px;
      max-width: 80%;
      align-self: flex-start;
      margin-right: 20%;
    }

    .mensagem-interna {
      background-color: #fff3cd;
      border-radius: 10px;
      padding: 15px;
      max-width: 80%;
      align-self: center;
      border-left: 4px solid #ffc107;
    }

    .mensagem-meta {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .input-area {
      border-top: 1px solid #ddd;
      padding-top: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
      font-size: 14px;
    }

    .input-area button {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }

    .input-area button:hover {
      background-color: #372fcc;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
      font-size: 16px;
    }

    .error {
      text-align: center;
      color: #dc2626;
      padding: 40px;
      font-size: 16px;
    }

    
  </style>
</head>
<body>
  <div class="container" id="main-container">
    <div class="header">
      <div class="ticket-info">
        <h2 id="ticket-numero">Carregando...</h2>
        <span class="tag" id="ticket-setor">Setor</span>
      </div>
      <div class="actions" id="actions-area">
        <!-- Bot√µes ser√£o mostrados apenas para agente -->
      </div>
    </div>

    <div class="user-section">
      <div class="user-info">
        <h3 id="cliente-nome">Carregando...</h3>
        <p id="cliente-email">Carregando...</p>
      </div>
    </div>

    <div class="ticket-meta">
      <p id="ticket-data">Carregando...</p>
      <p><strong id="ticket-status">Carregando...</strong></p>
    </div>

    <div class="chat-area" id="chat-area">
      <div class="loading">Carregando mensagens...</div>
    </div>

    <div class="input-area" id="input-area">
      <input id="mensagem" type="text" placeholder="Digite sua resposta...">
      <button id="enviar">Enviar</button>
    </div>
  </div>

  <script>
    // Constantes da API
// Constantes da API
const baseURL = 'https://localhost:7269';
const API_TICKETS = `${baseURL}/api/Tickets`;
const API_MENSAGENS = `${baseURL}/api/Mensagens`;

// Pegar IDs da URL
const urlParams = new URLSearchParams(window.location.search);
const idTicket = urlParams.get('id');
const idAgente = urlParams.get('agente');
const idCliente = localStorage.getItem("IdCliente");

// Verificar quem est√° acessando
const ehAgente = !!idAgente;
const usuarioAtualId = ehAgente ? parseInt(idAgente) : parseInt(idCliente);
const ehIA = usuarioAtualId === 9999; // ‚úÖ Identificar se √© IA - AGORA DEPOIS da declara√ß√£o


// Elementos DOM
const chatArea = document.getElementById("chat-area");
const input = document.getElementById("mensagem");
const enviar = document.getElementById("enviar");
const actionsArea = document.getElementById("actions-area");
const inputArea = document.getElementById("input-area");
const mainContainer = document.getElementById("main-container");

// ==================== CONFIGURA√á√ÉO INICIAL ====================

// Verificar se est√° logado
if (!usuarioAtualId) {
    alert("Acesso negado! Fa√ßa login primeiro.");
    window.location.href = ehAgente ? "../login-agente.html" : "../login.html";
}

// Configurar interface baseada no tipo de usu√°rio
function configurarInterface() {
    if (ehAgente) {
        // AGENTE: Mostra bot√µes de a√ß√£o
        actionsArea.innerHTML = `
            <button class="btn-voltar" onclick="voltarDashboard()">‚Üê Voltar</button>
            <button class="btn-encaminhar" id="btn-encaminhar">Encaminhar N2</button>
            <button class="btn-encerrar" id="btn-encerrar">Encerrar Chamado</button>
        `;
        document.title = "Detalhes do Ticket - Agente";
        
        // ‚úÖ ADICIONAR EVENT LISTENERS AP√ìS CRIAR OS BOT√ïES
        setTimeout(() => {
            const btnEncerrar = document.getElementById('btn-encerrar');
            if (btnEncerrar) {
                btnEncerrar.addEventListener("click", encerrarTicket);
            }
        }, 100);
        
    } else {
        // CLIENTE: Esconde apenas bot√µes de a√ß√£o do agente, MAS MANT√âM O INPUT!
        actionsArea.style.display = 'none';
        // ‚ö†Ô∏è N√ÉO esconde o input-area para cliente!
        document.title = "Detalhes do Ticket - Cliente";
    }
    
    // ‚úÖ AMBOS (cliente e agente) podem enviar mensagens!
    if (enviar) {
        enviar.addEventListener("click", enviarMensagem);
    }
    if (input) {
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") enviarMensagem();
        });
    }
}

// ==================== FUN√á√ïES PRINCIPAIS ====================

async function carregarTicket() {
    if (!idTicket) {
        mostrarErro("Ticket n√£o encontrado!");
        return;
    }

    try {
        console.log("üîÑ Carregando ticket:", idTicket);
        const response = await fetch(`${API_TICKETS}/${idTicket}`);
        if (!response.ok) throw new Error("Erro ao carregar ticket");
        
        const ticket = await response.json();
        console.log("‚úÖ Ticket carregado:", ticket);
        atualizarInterface(ticket);
        await carregarMensagens();
        
    } catch (error) {
        console.error("Erro:", error);
        mostrarErro("Erro ao carregar ticket: " + error.message);
    }
}

function atualizarInterface(ticket) {
    document.getElementById('ticket-numero').textContent = `Ticket #${ticket.idTicket}`;
    document.getElementById('ticket-setor').textContent = ticket.prioridade || 'Geral';
    document.getElementById('cliente-nome').textContent = ticket.cliente?.nome || 'Cliente';
    document.getElementById('cliente-email').textContent = ticket.cliente?.email || 'Email n√£o informado';
    document.getElementById('ticket-data').textContent = `Criado em ${new Date(ticket.dataCriacao).toLocaleString('pt-BR')}`;
    document.getElementById('ticket-status').textContent = ticket.status || 'Aberto';

    // Atualizar a√ß√µes baseadas no status (apenas para agente)
    if (ehAgente) {
        const btnEncerrar = document.getElementById('btn-encerrar');
        if (btnEncerrar && ticket.status?.toLowerCase() === 'fechado') {
            btnEncerrar.textContent = 'Ticket Fechado';
            btnEncerrar.disabled = true;
            btnEncerrar.style.backgroundColor = '#6b7280';
        }
    }
}

// ‚úÖ CORRE√á√ÉO: Fun√ß√£o carregarMensagens corrigida
async function carregarMensagens() {
    try {
        console.log("üîÑ Carregando mensagens para ticket:", idTicket);
        const response = await fetch(`${API_MENSAGENS}/ticket/${idTicket}`);
        if (!response.ok) throw new Error("Erro ao carregar mensagens");
        
        const mensagens = await response.json();
        console.log("‚úÖ Mensagens carregadas:", mensagens.length);
        chatArea.innerHTML = '';

        // ‚úÖ CORRE√á√ÉO: Verifica se precisa criar a mensagem inicial
        const precisaCriarMensagemInicial = await verificarSePrecisaMensagemInicial(mensagens);
        
        if (precisaCriarMensagemInicial) {
            console.log("üìù Criando mensagem inicial com descri√ß√£o...");
            await criarMensagemInicial();
        } else {
            // Se j√° tem mensagens, apenas exibe elas
            mensagens.forEach(mensagem => {
                adicionarMensagemNaTela(mensagem);
            });
        }

        chatArea.scrollTop = chatArea.scrollHeight;
    } catch (error) {
        console.error("Erro:", error);
        chatArea.innerHTML = '<div class="error">Erro ao carregar mensagens</div>';
    }
}

// ‚úÖ NOVA FUN√á√ÉO: Verifica se precisa criar mensagem inicial
async function verificarSePrecisaMensagemInicial(mensagens) {
    // Se n√£o tem nenhuma mensagem, precisa criar
    if (mensagens.length === 0) {
        return true;
    }
    
    // Se j√° tem mensagens, verifica se alguma √© a descri√ß√£o do ticket
    try {
        const ticketResponse = await fetch(`${API_TICKETS}/${idTicket}`);
        const ticket = await ticketResponse.json();
        const descricaoTicket = ticket.descricao;
        
        // Verifica se alguma mensagem existente j√° √© a descri√ß√£o
        const jaTemDescricao = mensagens.some(mensagem => 
            mensagem.texto === descricaoTicket
        );
        
        return !jaTemDescricao;
    } catch (error) {
        console.error("Erro ao verificar mensagem inicial:", error);
        return false;
    }
}

// ‚úÖ CORRE√á√ÉO: Fun√ß√£o criarMensagemInicial melhorada
async function criarMensagemInicial() {
    try {
        console.log("üìù Buscando dados do ticket para criar mensagem inicial...");
        const response = await fetch(`${API_TICKETS}/${idTicket}`);
        if (!response.ok) throw new Error("Erro ao buscar ticket");
        
        const ticket = await response.json();
        
        if (ticket.descricao) {
            const mensagemInicial = {
                IDTicket: parseInt(idTicket),
                IDCliente: ticket.idCliente, // ID real do cliente
                Texto: ticket.descricao,
                EhInterno: false
            };

            console.log("üì§ Enviando mensagem inicial:", mensagemInicial);
            const resp = await fetch(API_MENSAGENS, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(mensagemInicial)
            });

            if (resp.ok) {
                console.log("‚úÖ Mensagem inicial criada com sucesso!");
                
                // Agora busca as mensagens atualizadas para mostrar
                const mensagensAtualizadas = await fetch(`${API_MENSAGENS}/ticket/${idTicket}`);
                const mensagens = await mensagensAtualizadas.json();
                
                // Limpa e exibe todas as mensagens
                chatArea.innerHTML = '';
                mensagens.forEach(mensagem => {
                    adicionarMensagemNaTela(mensagem);
                });
                
                chatArea.scrollTop = chatArea.scrollHeight;
            } else {
                console.error("‚ùå Erro HTTP ao criar mensagem inicial:", resp.status);
                throw new Error("Erro ao criar mensagem inicial");
            }
        } else {
            console.log("‚ÑπÔ∏è Ticket n√£o tem descri√ß√£o para criar mensagem inicial");
        }
    } catch (error) {
        console.error("‚ùå Erro ao criar mensagem inicial:", error);
        // Mesmo com erro, tenta carregar as mensagens existentes
        try {
            const mensagensResponse = await fetch(`${API_MENSAGENS}/ticket/${idTicket}`);
            const mensagens = await mensagensResponse.json();
            
            chatArea.innerHTML = '';
            mensagens.forEach(mensagem => {
                adicionarMensagemNaTela(mensagem);
            });
        } catch (err) {
            console.error("Erro ao carregar mensagens ap√≥s falha:", err);
        }
    }
}

function adicionarMensagemNaTela(mensagem) {
    const div = document.createElement("div");
    
    if (mensagem.ehInterno) {
        div.className = "mensagem-interna";
        div.innerHTML = `<p><strong>üìã Nota Interna:</strong> ${mensagem.texto}</p>`;
    } else if (mensagem.idCliente === usuarioAtualId) {
        // MINHA MENSAGEM (direita - branca)
        div.className = "minha-mensagem";
        div.innerHTML = `<p>${mensagem.texto}</p>`;
    } else {
        // MENSAGEM DO OUTRO (esquerda - roxa) - INCLUINDO IA COMO AGENTE
        div.className = "mensagem-outro";
        
        // ‚úÖ DETECTAR SE √â MENSAGEM DA IA (ID espec√≠fico ou l√≥gica de neg√≥cio)
        const ehIA = mensagem.idCliente === 9999 || mensagem.remetente === 'IA'; // ajuste conforme sua l√≥gica
        
        const remetenteNome = ehIA ? 'Assistente Virtual' : (ehAgente ? 'Cliente' : 'Agente');
        div.innerHTML = `<p><strong>${remetenteNome}:</strong> ${mensagem.texto}</p>`;
    }

    const meta = document.createElement("div");
    meta.className = "mensagem-meta";
    const remetenteNome = (mensagem.idCliente === usuarioAtualId) ? 'Voc√™' : 
                         (mensagem.idCliente === 9999 ? 'Assistente Virtual' : 
                         (ehAgente ? 'Cliente' : 'Agente'));
    meta.textContent = `${remetenteNome} - ${new Date(mensagem.dataEnvio).toLocaleString('pt-BR')}`;
    div.appendChild(meta);

    chatArea.appendChild(div);
}

async function enviarMensagem() {
    const texto = input.value.trim();
    if (texto === "") return;

    try {
        const novaMensagem = {
            IDTicket: parseInt(idTicket),
            IDCliente: usuarioAtualId,
            Texto: texto,
            EhInterno: false
        };

        console.log("üì§ Enviando mensagem:", novaMensagem);
        const response = await fetch(API_MENSAGENS, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(novaMensagem)
        });

        if (!response.ok) throw new Error("Erro ao enviar mensagem");

        input.value = "";
        await carregarMensagens();

    } catch (error) {
        console.error("Erro:", error);
        alert("‚ùå Erro ao enviar mensagem: " + error.message);
    }
}
// Fun√ß√£o para a IA enviar mensagem como agente
async function enviarMensagemIA(texto) {
    try {
        const mensagemIA = {
            IDTicket: parseInt(idTicket),
            IDCliente: 9999, // ‚úÖ ID espec√≠fico para IA (ou ajuste conforme sua l√≥gica)
            Texto: texto,
            EhInterno: false,
            Remetente: 'IA' // ‚úÖ Identificador adicional
        };

        const response = await fetch(API_MENSAGENS, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(mensagemIA)
        });

        if (response.ok) {
            await carregarMensagens();
        }
    } catch (error) {
        console.error("Erro ao enviar mensagem da IA:", error);
    }
}
// ‚úÖ FUN√á√ÉO PARA ENCERRAR TICKET (AGENTE)
async function encerrarTicket() {
    if (!confirm("Tem certeza que deseja encerrar este chamado?")) {
        return;
    }

    try {
        const idAgente = localStorage.getItem("IdAgente");
        if (!idAgente) {
            alert("‚ùå Agente n√£o identificado. Fa√ßa login novamente.");
            return;
        }

        // Primeiro, busca o ticket atual para manter os outros dados
        const ticketResponse = await fetch(`${API_TICKETS}/${idTicket}`);
        if (!ticketResponse.ok) throw new Error("Erro ao buscar ticket");
        
        const ticketAtual = await ticketResponse.json();

        // Prepara o payload mantendo todos os dados e atualizando apenas status e data
        const payload = {
            idTicket: parseInt(idTicket),
            idCliente: ticketAtual.idCliente,
            idAgente: parseInt(idAgente), // Atualiza com o agente que est√° encerrando
            idProblema: ticketAtual.idProblema,
            titulo: ticketAtual.titulo,
            descricao: ticketAtual.descricao,
            status: "Resolvido", // ‚úÖ Muda o status
            prioridade: ticketAtual.prioridade,
            dataCriacao: ticketAtual.dataCriacao,
            dataFechamento: new Date().toISOString() // ‚úÖ Adiciona data de fechamento
        };

        console.log("üîÑ Encerrando ticket:", idTicket);
        console.log("Payload:", payload);

        const response = await fetch(`${API_TICKETS}/${idTicket}`, {
            method: "PUT",
            headers: { 
                "Content-Type": "application/json" 
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert("‚úÖ Ticket encerrado com sucesso!");
            
            // Atualiza a interface imediatamente
            document.getElementById('ticket-status').textContent = 'Resolvido';
            
            // Desabilita o bot√£o
            const btnEncerrar = document.getElementById('btn-encerrar');
            if (btnEncerrar) {
                btnEncerrar.textContent = 'Resolvido ‚úì';
                btnEncerrar.disabled = true;
                btnEncerrar.style.backgroundColor = '#10b981';
                btnEncerrar.style.cursor = 'not-allowed';
            }
            
            console.log("‚úÖ Ticket marcado como Resolvido");
            
        } else {
            const errorText = await response.text();
            throw new Error(errorText || "Erro ao encerrar ticket");
        }
        
    } catch (error) {
        console.error("‚ùå Erro ao encerrar ticket:", error);
        alert("‚ùå Erro ao encerrar ticket: " + error.message);
    }
}

// ‚úÖ ADICIONAR EVENT LISTENER
document.addEventListener('DOMContentLoaded', function() {
    const btnEncerrar = document.getElementById('btn-encerrar');
    if (btnEncerrar) {
        btnEncerrar.addEventListener('click', encerrarTicket);
        console.log("‚úÖ Event listener adicionado ao bot√£o Encerrar");
    }
});

function voltarDashboard() {
    if (ehAgente) {
        window.location.href = "../index.html";
    } else {
        window.location.href = "../clientetkt.html";
    }
}

function mostrarErro(mensagem) {
    chatArea.innerHTML = `<div class="error">${mensagem}</div>`;
}

// ==================== INICIALIZA√á√ÉO ====================

document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Iniciando p√°gina de ticket...");
    console.log("Usu√°rio:", ehAgente ? "Agente" : "Cliente", "ID:", usuarioAtualId);
    console.log("Ticket ID:", idTicket);
    
    configurarInterface();
    carregarTicket();
});
  </script>
</body>
</html>